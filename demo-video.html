<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FENIX IA &mdash; C&oacute;mo funciona</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --ink:#0f172a;--ink2:#334155;--ink3:#64748b;--ink4:#94a3b8;
  --bg:#0f172a;--card:#1e293b;--card2:#334155;
  --teal:#0d9488;--teal-light:#14b8a6;--teal-pale:#ccfbf1;--teal-glow:rgba(13,148,136,.15);
  --green:#059669;--orange:#d97706;--red:#dc2626;
  --font:'Inter',system-ui,-apple-system,sans-serif;
}
html,body{height:100%;overflow:hidden}
body{font-family:var(--font);background:var(--bg);color:#fff;-webkit-font-smoothing:antialiased}

/* CONTAINER */
.player{position:relative;width:100%;height:100vh;max-width:960px;max-height:540px;margin:0 auto;overflow:hidden;background:var(--bg);border-radius:0}
/* When embedded, fill container */
body.embedded .player{max-width:100%;max-height:100%;height:100vh;border-radius:0}

/* SCENES */
.scene{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;opacity:0;transform:scale(.97);transition:opacity .8s ease, transform .8s ease;pointer-events:none;padding:40px}
.scene.active{opacity:1;transform:scale(1);pointer-events:auto}

/* PROGRESS BAR */
.progress{position:absolute;top:0;left:0;height:3px;background:linear-gradient(90deg,var(--teal),var(--teal-light));width:0%;transition:width .3s linear;z-index:10}

/* LOGO WATERMARK */
.watermark{position:absolute;top:16px;left:20px;display:flex;align-items:center;gap:6px;z-index:10;opacity:.6}
.watermark img{height:20px;filter:brightness(2)}
.watermark span{font-size:.75rem;font-weight:800;color:#fff;letter-spacing:.3px}
.watermark em{font-style:normal;color:var(--teal-light)}

/* CONTROLS */
.controls{position:absolute;bottom:16px;left:0;right:0;display:flex;justify-content:center;gap:8px;z-index:10}
.dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.2);cursor:pointer;transition:all .3s}
.dot.active{background:var(--teal);transform:scale(1.3)}
.play-pause{position:absolute;bottom:14px;right:20px;background:none;border:none;color:rgba(255,255,255,.4);font-size:1.1rem;cursor:pointer;z-index:10;transition:color .2s}
.play-pause:hover{color:#fff}
.sound-btn{position:absolute;bottom:14px;left:20px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);color:rgba(255,255,255,.5);font-size:1rem;padding:6px 8px;border-radius:50%;cursor:pointer;z-index:10;transition:all .2s;width:32px;height:32px;display:flex;align-items:center;justify-content:center}
.sound-btn:hover{background:rgba(255,255,255,.15);color:#fff}
.sound-btn.active{background:var(--teal);color:#fff;border-color:var(--teal)}

/* SOUND OVERLAY */
.sound-overlay{position:absolute;inset:0;background:rgba(15,23,42,.85);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:20;cursor:pointer;transition:opacity .5s;-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px)}
.sound-overlay.hidden{opacity:0;pointer-events:none}
.so-circle{width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,var(--teal),var(--teal-light));display:flex;align-items:center;justify-content:center;font-size:2.2rem;margin-bottom:14px;box-shadow:0 0 40px rgba(13,148,136,.4);transition:transform .2s}
.sound-overlay:hover .so-circle{transform:scale(1.1)}
.so-text{font-size:.95rem;font-weight:700;color:#fff;letter-spacing:.3px}

/* SCENE 1: IMAGINE */
.s1-title{font-size:2.8rem;font-weight:900;text-align:center;line-height:1.15;opacity:0;animation:none}
.s1-title em{font-style:italic;color:var(--teal-light)}
.s1-sub{font-size:1rem;color:rgba(255,255,255,.5);text-align:center;margin-top:12px;max-width:500px;opacity:0}
.scene.active .s1-title{animation:fadeUp .8s .2s forwards}
.scene.active .s1-sub{animation:fadeUp .8s .6s forwards}

/* SCENE 2: THE PROBLEM */
.s2-label{font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:var(--teal-light);margin-bottom:20px;opacity:0}
.s2-cards{display:flex;gap:16px;opacity:0}
.s2-card{background:var(--card);border-radius:12px;padding:20px;border:1px solid rgba(255,255,255,.06);width:200px;text-align:center}
.s2-card .icon{font-size:2rem;margin-bottom:8px}
.s2-card .title{font-size:.85rem;font-weight:800;margin-bottom:4px}
.s2-card .desc{font-size:.7rem;color:rgba(255,255,255,.45);line-height:1.4}
.scene.active .s2-label{animation:fadeUp .6s .2s forwards}
.scene.active .s2-cards{animation:fadeUp .6s .5s forwards}

/* SCENE 3: THE CALL */
.s3-phone{width:320px;background:var(--card);border-radius:16px;padding:24px;border:1px solid rgba(255,255,255,.08);position:relative;opacity:0}
.s3-header{display:flex;align-items:center;gap:10px;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,.06)}
.s3-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--teal),var(--green));display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.7rem}
.s3-info .name{font-size:.85rem;font-weight:700}
.s3-info .meta{font-size:.65rem;color:rgba(255,255,255,.4)}
.s3-wave{display:flex;align-items:center;gap:3px;justify-content:center;margin:16px 0}
.s3-wave .bar{width:3px;border-radius:2px;background:var(--teal-light);animation:wave 1.2s ease-in-out infinite}
.s3-wave .bar:nth-child(1){height:12px;animation-delay:0s}
.s3-wave .bar:nth-child(2){height:20px;animation-delay:.15s}
.s3-wave .bar:nth-child(3){height:28px;animation-delay:.3s}
.s3-wave .bar:nth-child(4){height:16px;animation-delay:.45s}
.s3-wave .bar:nth-child(5){height:24px;animation-delay:.6s}
.s3-wave .bar:nth-child(6){height:10px;animation-delay:.75s}
.s3-wave .bar:nth-child(7){height:18px;animation-delay:.9s}
.s3-timer{text-align:center;font-size:.75rem;color:rgba(255,255,255,.3);font-variant-numeric:tabular-nums}
.s3-badge{position:absolute;top:-10px;right:-10px;background:var(--teal);color:#fff;font-size:.6rem;font-weight:700;padding:4px 10px;border-radius:100px;display:flex;align-items:center;gap:4px}
.s3-badge::before{content:'';width:6px;height:6px;border-radius:50%;background:#fff;animation:pulse-dot 1.5s infinite}
.s3-side{position:absolute;right:-180px;top:50%;transform:translateY(-50%);opacity:0;width:160px}
.s3-side-item{background:var(--card);border-radius:8px;padding:8px 10px;margin-bottom:6px;border:1px solid rgba(255,255,255,.06);font-size:.6rem;opacity:0}
.s3-side-item .si-label{color:rgba(255,255,255,.35);font-size:.5rem;margin-bottom:2px}
.s3-side-item .si-val{font-weight:700;color:var(--teal-light)}
.scene.active .s3-phone{animation:fadeUp .7s .2s forwards}
.scene.active .s3-side{animation:fadeIn .5s 1s forwards}
.scene.active .s3-side-item:nth-child(1){animation:fadeLeft .4s 1.2s forwards}
.scene.active .s3-side-item:nth-child(2){animation:fadeLeft .4s 1.5s forwards}
.scene.active .s3-side-item:nth-child(3){animation:fadeLeft .4s 1.8s forwards}

/* SCENE 4: QUESTIONS */
.s4-wrap{display:flex;gap:24px;align-items:flex-start;opacity:0}
.s4-left{width:260px}
.s4-dept{font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--teal-light);margin-bottom:12px}
.s4-questions{display:flex;flex-direction:column;gap:6px}
.s4-q{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--card);border-radius:8px;border:1px solid rgba(255,255,255,.06);font-size:.7rem;opacity:0;transform:translateX(-10px)}
.s4-q .qmark{width:20px;height:20px;border-radius:50%;background:var(--teal-glow);color:var(--teal-light);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.55rem;flex-shrink:0}
.s4-right{width:280px}
.s4-answer{background:var(--card);border-radius:10px;padding:14px 16px;border:1px solid var(--teal);opacity:0;transform:translateY(10px)}
.s4-answer .a-label{font-size:.55rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--teal-light);margin-bottom:6px}
.s4-answer .a-q{font-size:.75rem;font-weight:700;margin-bottom:6px}
.s4-answer .a-text{font-size:.68rem;color:rgba(255,255,255,.6);line-height:1.5}
.s4-answer .a-text strong{color:var(--teal-light);font-weight:700}
.s4-answer .a-tag{display:inline-flex;margin-top:8px;padding:2px 8px;border-radius:100px;font-size:.55rem;font-weight:700;background:rgba(5,150,105,.15);color:var(--green)}
.scene.active .s4-wrap{animation:fadeIn .3s .1s forwards}
.scene.active .s4-q:nth-child(1){animation:fadeRight .4s .3s forwards}
.scene.active .s4-q:nth-child(2){animation:fadeRight .4s .5s forwards}
.scene.active .s4-q:nth-child(3){animation:fadeRight .4s .7s forwards}
.scene.active .s4-q:nth-child(4){animation:fadeRight .4s .9s forwards}
.scene.active .s4-answer{animation:fadeUp .5s 1.3s forwards}

/* SCENE 5: DASHBOARD */
.s5-dash{width:520px;background:var(--card);border-radius:14px;padding:20px;border:1px solid rgba(255,255,255,.08);opacity:0}
.s5-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid rgba(255,255,255,.06)}
.s5-header .title{font-size:.85rem;font-weight:800}
.s5-header .live{display:flex;align-items:center;gap:4px;font-size:.65rem;color:var(--teal-light);font-weight:600}
.s5-header .live::before{content:'';width:6px;height:6px;border-radius:50%;background:var(--teal-light);animation:pulse-dot 1.5s infinite}
.s5-metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px}
.s5-metric{text-align:center;padding:10px 6px;border-radius:8px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.04)}
.s5-metric .val{font-size:1.3rem;font-weight:900}
.s5-metric .lbl{font-size:.55rem;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.5px}
.s5-alerts{display:flex;flex-direction:column;gap:6px}
.s5-alert{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,.06);font-size:.7rem;opacity:0;transform:translateY(6px)}
.s5-alert .a-icon{font-size:1rem;flex-shrink:0}
.s5-alert .a-type{font-size:.5rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px}
.s5-alert .a-text{font-size:.65rem;color:rgba(255,255,255,.55)}
.scene.active .s5-dash{animation:fadeUp .6s .2s forwards}
.scene.active .s5-alert:nth-child(1){animation:fadeUp .4s .8s forwards}
.scene.active .s5-alert:nth-child(2){animation:fadeUp .4s 1.1s forwards}
.scene.active .s5-alert:nth-child(3){animation:fadeUp .4s 1.4s forwards}

/* SCENE 6: CTA */
.s6-title{font-size:2rem;font-weight:900;text-align:center;line-height:1.2;opacity:0}
.s6-title em{font-style:italic;color:var(--teal-light)}
.s6-sub{font-size:.9rem;color:rgba(255,255,255,.45);text-align:center;margin-top:8px;opacity:0}
.s6-btn{display:inline-flex;align-items:center;gap:6px;padding:12px 28px;border-radius:8px;background:linear-gradient(135deg,var(--teal),var(--green));color:#fff;font-weight:700;font-size:.9rem;margin-top:20px;text-decoration:none;opacity:0;cursor:pointer;border:none;font-family:var(--font);transition:transform .2s}
.s6-btn:hover{transform:translateY(-2px)}
.s6-stats{display:flex;gap:24px;margin-top:20px;opacity:0}
.s6-stat{text-align:center}
.s6-stat .v{font-size:1.1rem;font-weight:900;color:var(--teal-light)}
.s6-stat .l{font-size:.55rem;color:rgba(255,255,255,.35);text-transform:uppercase;letter-spacing:.8px}
.scene.active .s6-title{animation:fadeUp .7s .2s forwards}
.scene.active .s6-sub{animation:fadeUp .7s .5s forwards}
.scene.active .s6-btn{animation:fadeUp .7s .8s forwards}
.scene.active .s6-stats{animation:fadeUp .7s 1.1s forwards}

/* KEYFRAMES */
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes fadeRight{from{opacity:0;transform:translateX(-10px)}to{opacity:1;transform:translateX(0)}}
@keyframes fadeLeft{from{opacity:0;transform:translateX(10px)}to{opacity:1;transform:translateX(0)}}
@keyframes wave{0%,100%{transform:scaleY(1)}50%{transform:scaleY(.4)}}
@keyframes pulse-dot{0%,100%{opacity:1}50%{opacity:.3}}
@keyframes typing{from{width:0}to{width:100%}}
</style>
</head>
<body>

<div class="player" id="player">
  <div class="progress" id="progress"></div>
  <div class="watermark"><img src="logo.png" alt=""><span>FENIX <em>IA</em></span></div>

  <!-- SCENE 1: IMAGINE -->
  <div class="scene active" data-duration="7000">
    <div class="s1-title"><em>Imagina</em> tener un departamento de calidad</div>
    <div class="s1-sub">Sin contratar a nadie. Sin escuchar una sola llamada. Autom&aacute;ticamente.</div>
  </div>

  <!-- SCENE 2: THE PROBLEM -->
  <div class="scene" data-duration="7500">
    <div class="s2-label">Lo que pasa hoy en tu empresa</div>
    <div class="s2-cards">
      <div class="s2-card"><div class="icon">&#128683;</div><div class="title">Se pierden mensajes</div><div class="desc">Tu equipo usa 5 canales distintos. Nadie ve el panorama completo.</div></div>
      <div class="s2-card"><div class="icon">&#128561;</div><div class="title">Clientes se van</div><div class="desc">El tono era negativo. Nadie lo detect&oacute;. Ya hablan con tu competencia.</div></div>
      <div class="s2-card"><div class="icon">&#128176;</div><div class="title">Ventas perdidas</div><div class="desc">Mencion&oacute; que necesita m&aacute;s. Nadie lo apunt&oacute;. La oportunidad desapareci&oacute;.</div></div>
    </div>
  </div>

  <!-- SCENE 3: THE CALL -->
  <div class="scene" data-duration="8000">
    <div style="position:relative">
      <div class="s3-phone">
        <div class="s3-badge"><span></span> La IA est&aacute; escuchando</div>
        <div class="s3-header">
          <div class="s3-avatar">CM</div>
          <div class="s3-info"><div class="name">Carlos Mart&iacute;nez</div><div class="meta">Cl&iacute;nica Dental Sol &middot; Cliente desde 2024</div></div>
        </div>
        <div class="s3-wave"><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
        <div class="s3-timer">02:34</div>
      </div>
      <div class="s3-side">
        <div class="s3-side-item"><div class="si-label">Sentimiento</div><div class="si-val" style="color:#f59e0b">&#9888; Negativo detectado</div></div>
        <div class="s3-side-item"><div class="si-label">Palabra clave</div><div class="si-val">&ldquo;me cambio&rdquo;</div></div>
        <div class="s3-side-item"><div class="si-label">Acci&oacute;n</div><div class="si-val" style="color:var(--red)">&#128680; Alerta de baja</div></div>
      </div>
    </div>
  </div>

  <!-- SCENE 4: QUESTIONS & ANSWERS -->
  <div class="scene" data-duration="9000">
    <div class="s4-wrap">
      <div class="s4-left">
        <div class="s4-dept">&#128200; Tus preguntas</div>
        <div class="s4-questions">
          <div class="s4-q"><div class="qmark">?</div>&iquest;El cliente mencion&oacute; irse?</div>
          <div class="s4-q"><div class="qmark">?</div>&iquest;Se resolvi&oacute; el problema?</div>
          <div class="s4-q"><div class="qmark">?</div>&iquest;Oportunidad de venta cruzada?</div>
          <div class="s4-q"><div class="qmark">?</div>&iquest;Siguiente paso propuesto?</div>
        </div>
      </div>
      <div class="s4-right">
        <div class="s4-answer">
          <div class="a-label">&#9889; Respuesta de la IA</div>
          <div class="a-q">&ldquo;&iquest;El cliente mencion&oacute; irse?&rdquo;</div>
          <div class="a-text"><strong>S&iacute;, alerta.</strong> El cliente dijo textualmente: &ldquo;Si no se resuelve esta semana, me cambio de cl&iacute;nica&rdquo;. Sentimiento negativo. Urgencia alta.</div>
          <div class="a-tag">&#128680; Riesgo de baja</div>
        </div>
      </div>
    </div>
  </div>

  <!-- SCENE 5: DASHBOARD -->
  <div class="scene" data-duration="8500">
    <div class="s5-dash">
      <div class="s5-header">
        <div class="title">Panel FENIX IA</div>
        <div class="live">En vivo</div>
      </div>
      <div class="s5-metrics">
        <div class="s5-metric"><div class="val" style="color:var(--teal-light)">347</div><div class="lbl">Comunicaciones</div></div>
        <div class="s5-metric"><div class="val" style="color:var(--green)">+78%</div><div class="lbl">Sentimiento +</div></div>
        <div class="s5-metric"><div class="val" style="color:#a78bfa">12</div><div class="lbl">Oportunidades</div></div>
        <div class="s5-metric"><div class="val" style="color:var(--orange)">2</div><div class="lbl">Alertas</div></div>
      </div>
      <div class="s5-alerts">
        <div class="s5-alert"><div class="a-icon">&#128680;</div><div><div class="a-type" style="color:var(--red)">Alerta de baja</div><div class="a-text">Carlos Mart&iacute;nez mencion&oacute; &ldquo;me cambio&rdquo; &mdash; Llamar antes del viernes</div></div></div>
        <div class="s5-alert"><div class="a-icon">&#128176;</div><div><div class="a-type" style="color:var(--green)">Oportunidad</div><div class="a-text">Laura G&oacute;mez interes&aacute; en seguro 2&ordf; vivienda &mdash; P&oacute;liza hogar adicional</div></div></div>
        <div class="s5-alert"><div class="a-icon">&#9889;</div><div><div class="a-type" style="color:var(--teal-light)">Insight</div><div class="a-text">Quejas recurrentes sobre tiempos de espera &mdash; 8 menciones esta semana</div></div></div>
      </div>
    </div>
  </div>

  <!-- SCENE 6: CTA -->
  <div class="scene" data-duration="9000">
    <div class="s6-title"><em>Imagina</em> dejar de adivinar.<br>Empieza a <em>escuchar.</em></div>
    <div class="s6-sub">Demo gratuita de 30 min con tus datos reales</div>
    <a href="#contacto" class="s6-btn" onclick="window.parent.document.querySelector('#contacto')?.scrollIntoView({behavior:'smooth'})">Solicitar demo gratuita &rarr;</a>
    <div class="s6-stats">
      <div class="s6-stat"><div class="v">99&euro;</div><div class="l">desde / mes</div></div>
      <div class="s6-stat"><div class="v">&infin;</div><div class="l">Comunicaciones</div></div>
      <div class="s6-stat"><div class="v">5</div><div class="l">Canales</div></div>
      <div class="s6-stat"><div class="v">&lt;24h</div><div class="l">Activaci&oacute;n</div></div>
    </div>
  </div>

  <!-- SOUND OVERLAY -->
  <div class="sound-overlay" id="soundOverlay" onclick="enableSound()">
    <div class="so-circle">&#128266;</div>
    <div class="so-text">Pulsa para activar la narraci&oacute;n</div>
  </div>

  <!-- CONTROLS -->
  <div class="controls" id="controls"></div>
  <button class="play-pause" id="playPause" onclick="togglePlay()">&#10074;&#10074;</button>
  <button class="sound-btn" id="soundBtn" onclick="toggleSound()">&#128264;</button>
</div>

<script>
const scenes = document.querySelectorAll('.scene');
const progressBar = document.getElementById('progress');
const controlsEl = document.getElementById('controls');
const playPauseBtn = document.getElementById('playPause');
let current = 0;
let playing = true;
let timer = null;
let sceneStart = 0;
let elapsed = 0;
let voiceReady = false;
let spanishVoice = null;
let narrationStarted = false;

// NARRATION — short punchy sentences, radio announcer style
const narrations = [
  [
    '¡Imagina! Tener un departamento de calidad escuchando cada llamada.',
    'Cada email.',
    'Cada WhatsApp de tu empresa.',
    'Sin contratar a nadie. Sin escuchar una sola llamada.',
    '¡Todo, automáticamente!'
  ],
  [
    'Hoy, tu equipo usa cinco canales distintos. ¡Y nadie ve el panorama completo!',
    'Los clientes se van en silencio.',
    'Las oportunidades de venta, ¡desaparecen en el ruido!'
  ],
  [
    'Con FÉNIX I A, la inteligencia artificial escucha cada comunicación, ¡en tiempo real!',
    'Detecta el sentimiento, las palabras clave, y genera alertas cuando algo requiere tu atención.'
  ],
  [
    'Tú defines las preguntas que importan para tu negocio.',
    'La I A escucha, y responde automáticamente.',
    '¿El cliente ha mencionado irse? ¡Sí, alerta! El cliente dijo: si no se resuelve, me cambio.'
  ],
  [
    '¡Todo se refleja en tu panel, en tiempo real!',
    'Trescientas cuarenta y siete comunicaciones. Doce oportunidades detectadas. Dos alertas de riesgo.',
    'Tienes el control total, ¡sin escuchar una sola llamada!'
  ],
  [
    '¡Imagina dejar de adivinar!',
    'Empieza a escuchar. Desde noventa y nueve euros al mes. Cinco canales. Comunicaciones ilimitadas.',
    '¡Activo en menos de veinticuatro horas! Solicita tu demo gratuita.'
  ]
];

// Find best MALE Spanish voice — prefer Enhanced/Premium (macOS neural)
function loadVoices() {
  const voices = speechSynthesis.getVoices();
  const esVoices = voices.filter(v => v.lang.startsWith('es'));
  const maleNames = ['Jorge','Diego','Andrés','Andres','Juan','Carlos','Enrique'];
  // 1st: Enhanced/Premium neural voices (macOS) — much more natural
  for (const name of maleNames) {
    const enhanced = esVoices.find(v => v.name.includes(name) && (v.name.includes('Enhanced') || v.name.includes('Premium')));
    if (enhanced) { spanishVoice = enhanced; break; }
  }
  // 2nd: Standard male voices
  if (!spanishVoice) {
    for (const name of maleNames) {
      const match = esVoices.find(v => v.name.includes(name));
      if (match) { spanishVoice = match; break; }
    }
  }
  // 3rd: Google español
  if (!spanishVoice) {
    spanishVoice = esVoices.find(v => v.name.includes('Google español')) || esVoices.find(v => v.name.includes('Google'));
  }
  // 4th: any Spanish voice
  if (!spanishVoice) spanishVoice = esVoices[0];
  if (spanishVoice) voiceReady = true;
}
speechSynthesis.onvoiceschanged = loadVoices;
loadVoices();

let speechDone = true;
let speakAborted = false;

// Speak with natural pauses: longer between sentences, shorter at commas
function speak(sentences) {
  speechSynthesis.cancel();
  if (!voiceReady || !sentences || !sentences.length) { speechDone = true; return; }
  speechDone = false;
  speakAborted = false;

  let idx = 0;
  function next() {
    if (speakAborted || idx >= sentences.length) { speechDone = true; return; }
    const text = sentences[idx];
    const utt = new SpeechSynthesisUtterance(text);
    utt.voice = spanishVoice;
    utt.lang = 'es-ES';
    utt.rate = 0.85;
    utt.pitch = 0.9;
    utt.volume = 1;
    // Chrome bug workaround
    let resumeTimer = setInterval(() => {
      if (!speechSynthesis.speaking) { clearInterval(resumeTimer); return; }
      speechSynthesis.pause();
      speechSynthesis.resume();
    }, 10000);
    utt.onend = () => {
      clearInterval(resumeTimer);
      idx++;
      if (idx < sentences.length && !speakAborted) {
        setTimeout(next, 400);
      } else {
        speechDone = true;
      }
    };
    utt.onerror = () => { clearInterval(resumeTimer); speechDone = true; };
    speechSynthesis.speak(utt);
  }
  next();
}

function stopSpeech() {
  speakAborted = true;
  speechSynthesis.cancel();
  speechDone = true;
}

// Create dots
scenes.forEach((_, i) => {
  const dot = document.createElement('div');
  dot.className = 'dot' + (i === 0 ? ' active' : '');
  dot.onclick = () => goTo(i);
  controlsEl.appendChild(dot);
});

function getTotalDuration() {
  let total = 0;
  scenes.forEach(s => total += parseInt(s.dataset.duration));
  return total;
}

function getProgressBefore(index) {
  let total = getTotalDuration();
  let before = 0;
  for (let i = 0; i < index; i++) before += parseInt(scenes[i].dataset.duration);
  return (before / total) * 100;
}

function updateProgress() {
  if (!playing) return;
  const now = Date.now();
  const sceneElapsed = now - sceneStart;
  const sceneDuration = parseInt(scenes[current].dataset.duration);
  const total = getTotalDuration();
  let before = 0;
  for (let i = 0; i < current; i++) before += parseInt(scenes[i].dataset.duration);
  const pct = ((before + Math.min(sceneElapsed, sceneDuration)) / total) * 100;
  progressBar.style.width = pct + '%';
  if (sceneElapsed < sceneDuration) requestAnimationFrame(updateProgress);
}

function goTo(index) {
  clearTimeout(timer);
  scenes[current].classList.remove('active');
  // Reset animations by cloning
  const old = scenes[current];
  const clone = old.cloneNode(true);
  clone.classList.remove('active');
  old.parentNode.replaceChild(clone, old);
  // Update NodeList reference trick: re-query
  const allScenes = document.querySelectorAll('.scene');

  current = index;
  allScenes[current].classList.add('active');

  // Update dots
  document.querySelectorAll('.dot').forEach((d, i) => d.classList.toggle('active', i === current));

  // Progress
  progressBar.style.width = getProgressBefore(current) + '%';
  sceneStart = Date.now();
  requestAnimationFrame(updateProgress);

  // Narrate
  if (narrationStarted && playing) speak(narrations[current]);

  if (playing) scheduleNext();
}

function scheduleNext() {
  clearTimeout(timer);
  const duration = parseInt(document.querySelectorAll('.scene')[current].dataset.duration);
  timer = setTimeout(() => {
    // Wait for narration to finish + buffer before transitioning
    function advance() {
      const allScenes = document.querySelectorAll('.scene');
      const next = (current + 1) % allScenes.length;
      goTo(next);
    }
    if (!speechDone && narrationStarted) {
      const waitForSpeech = setInterval(() => {
        if (speechDone || !playing) {
          clearInterval(waitForSpeech);
          setTimeout(advance, 600); // breathing room after last sentence
        }
      }, 150);
    } else {
      advance();
    }
  }, duration);
}

function togglePlay() {
  playing = !playing;
  playPauseBtn.innerHTML = playing ? '&#10074;&#10074;' : '&#9654;';
  if (playing) {
    narrationStarted = true;
    sceneStart = Date.now();
    requestAnimationFrame(updateProgress);
    speak(narrations[current]);
    scheduleNext();
  } else {
    clearTimeout(timer);
    stopSpeech();
  }
}

function enableSound() {
  document.getElementById('soundOverlay').classList.add('hidden');
  narrationStarted = true;
  const btn = document.getElementById('soundBtn');
  btn.classList.add('active');
  btn.innerHTML = '&#128266;';
  if (playing) speak(narrations[current]);
}

function toggleSound() {
  const btn = document.getElementById('soundBtn');
  narrationStarted = !narrationStarted;
  if (narrationStarted) {
    btn.classList.add('active');
    btn.innerHTML = '&#128266;';
    if (playing) speak(narrations[current]);
  } else {
    btn.classList.remove('active');
    btn.innerHTML = '&#128264;';
    stopSpeech();
  }
}

// Keyboard
document.addEventListener('keydown', e => {
  const allScenes = document.querySelectorAll('.scene');
  if (e.key === 'ArrowRight') goTo((current + 1) % allScenes.length);
  if (e.key === 'ArrowLeft') goTo((current - 1 + allScenes.length) % allScenes.length);
  if (e.key === ' ') { e.preventDefault(); togglePlay(); }
});

// Check if embedded
if (window.self !== window.top) document.body.classList.add('embedded');

// Start
sceneStart = Date.now();
requestAnimationFrame(updateProgress);
scheduleNext();
</script>

</body>
</html>